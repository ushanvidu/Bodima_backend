name: CI Pipeline - Bodima App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build and Test with Maven
        run: mvn clean test surefire-report:report
        env:
          SPRING_PROFILES_ACTIVE: test
          SPRING_DATASOURCE_URL: jdbc:h2:mem:testdb
          SPRING_DATASOURCE_USERNAME: sa
          SPRING_DATASOURCE_PASSWORD: password

      - name: Verify Test Reports Exist
        run: |
          echo "Checking for test reports..."
          if [ -f "target/site/surefire-report.html" ]; then
            echo "âœ… HTML report generated: target/site/surefire-report.html"
          else
            echo "âš ï¸  HTML report not found, checking for XML reports..."
          fi
          
          if [ -d "target/surefire-reports" ]; then
            echo "âœ… XML reports generated in: target/surefire-reports/"
            echo "Number of test suites: $(find target/surefire-reports -name "*.xml" | wc -l)"
          else
            echo "âŒ No test reports found"
            exit 1
          fi

      - name: Upload Test Reports
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            target/surefire-reports/
            target/site/surefire-report.html

      - name: Build JAR Package
        run: mvn package -DskipTests

      - name: Upload JAR Artifact
        uses: actions/upload-artifact@v4
        with:
          name: bodima-app
          path: target/*.jar

      - name: Show Build Summary
        run: |
          echo "ğŸ‰ BUILD SUMMARY"
          echo "================"
          echo "âœ… Tests completed successfully"
          echo "ğŸ“¦ JAR file: $(ls target/*.jar 2>/dev/null || echo 'Not found')"
          echo "ğŸ“Š Test reports available as artifacts"