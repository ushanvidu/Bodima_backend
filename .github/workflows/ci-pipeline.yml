name: CI Pipeline - Bodima App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build project
        run: mvn clean compile

      - name: Run tests and generate reports
        run: |
          mvn test surefire-report:report
        env:
          SPRING_PROFILES_ACTIVE: test
          SPRING_DATASOURCE_URL: jdbc:h2:mem:testdb
          SPRING_DATASOURCE_USERNAME: sa
          SPRING_DATASOURCE_PASSWORD: password

      - name: Verify reports generated
        run: |
          echo "Checking for generated reports..."
          if [ -f "target/site/surefire-report.html" ]; then
            echo "✅ HTML report found: target/site/surefire-report.html"
            echo "📊 Report size: $(du -h target/site/surefire-report.html | cut -f1)"
          else
            echo "❌ HTML report not found at target/site/surefire-report.html"
            echo "📁 Checking what exists in target/site/:"
            ls -la target/site/ 2>/dev/null || echo "No target/site directory"
          fi
          
          if [ -d "target/surefire-reports" ]; then
            echo "✅ XML reports found in target/surefire-reports/"
            echo "📄 Number of test files: $(find target/surefire-reports -name "*.xml" | wc -l)"
          else
            echo "❌ No XML reports found"
          fi

      - name: Upload HTML test report
        uses: actions/upload-artifact@v4
        with:
          name: test-results-html
          path: target/site/surefire-report.html
          if-no-files-found: warn

      - name: Upload XML test reports
        uses: actions/upload-artifact@v4
        with:
          name: test-results-xml
          path: target/surefire-reports/
          if-no-files-found: warn

      - name: Build JAR package
        run: mvn package -DskipTests

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: bodima-app
          path: target/*.jar

      - name: Show final status
        run: |
          echo "🎉 CI Pipeline Completed!"
          echo "✅ Build: Successful"
          echo "✅ Tests: Executed"
          echo "📦 JAR: Built and ready"
          echo "📊 Reports: Generated and uploaded"